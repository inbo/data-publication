---
title: "Darwin Core Mapping"
subtitle: "Biofresh resque script"
author: "Dimitri Brosens"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Load libraries:

```{r message = FALSE}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(readxl)         # To read Excel files
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(sp)             # coordinate transformation
library(leaflet)        # coordinate transformation
library(widgetframe)    # coordinate transformation
library(sf)             # coordinate transformation
library(lubridate)      # for the date
```

# Read source data

Create a data frame `input_data` from the source data:
The source data was corrected in Excel
Muskrat occurrences opened in openRefine
Obsolete columns removed
some columns renamed to DwC term
File exported to csv

```{r}


input_interim <- read_delim(here::here("datasets", "biofresh-dematen", "data", "raw", "maten_dwceventid_20181011.txt" ), ",")

input_interim_occ <- read_delim(here::here("datasets", "biofresh-dematen", "data", "raw", "maten_dwcoccurrences_20190327.txt" ), ";")

```

Preview data:

```{r}
input_interim %>% head(n = 5)
```


```{r}
input_interim_occ %>% head(n = 5)
```

# Process source data

## Tidy data

Clean data somewhat:

```{r}
input_interim %<>% remove_empty("rows")
```

```{r}
input_interim %>% head(n = 5)
```

# Georeference source data


## Lambert to Decimals

### Keep original x,Y as verbatimcoordinates

We want to keep the original verbatim Coordinates
The original X,Y will be used for creating decimalLatitude and decimalLongitude

```{r}
input_interim %<>% mutate(verbatimLongitude = X) %>%
                   mutate(verbatimLatitude = Y) 
                   
```

### Create a spacial dataframe

Create spatial dataframe and define the CRS (31370 is Belgian Lambert 72)
We indicate the x,y columns as coordinates and define the coordinate system

```{r}
input_interim = st_as_sf(input_interim, coords = c("X","Y"), crs = 31370 , agr = "constant" )
input_interim %>% head(n = 5)
```

## Transform the data in WGS84

Now we transform the Lambert 72 in WGS84

```{r}
input_interim <- st_transform(input_interim, crs = 4326)
input_interim %>% head(n = 5)
```

### Create a dataframe with column decimalLatitude & decimalLongitude

In order to add the decimal coordinates into the original df we create an x_y dataframe

```{r}
x_y <- as.data.frame(st_coordinates(input_interim))
x_y %>% head(n = 5)

write_csv(x_y, here::here("datasets", "biofresh-dematen", "data", "interim", "x_y.csv"), na = "")
```

# Create extra dataframe to work with 

```{r}
input_interim_df <- input_interim
```

# Remove geometry from dataframe 'input_interim_df'

We remove all geometry from the spacial dataframe, to create a normal df

```{r}
st_geometry(input_interim_df) <- NULL

input_interim_df %>% head(n = 5)
```

### Bind columns x_y and input_interim_df

Join both df's to have the decimalLat & Lon

```{r}
input_interim_df = bind_cols(input_interim_df,x_y, .id = NULL)

input_interim_df %>% head(n = 5)
```

### Integrate x-y coordinates in original dataframe

We can safely substitute input_interim 

```{r}
input_interim <- input_interim_df
```

# Occurrence core

## Pre-processing

Create a dataframe occurrence data only 

```{r}
event <- input_interim
```


```{r}
occurrence <- input_interim_occ
```


```{r}
occurrence %<>% mutate(organismQuantityType = "CPUE, Number of Specimens per Fike per Day")
```


```{r}
# Step 1: convert scientificName to character first
occurrence$scientificName <- as.character(occurrence$scientificName)


```


```{r}
# Replace invalid bytes with a placeholder or remove them
occurrence$scientificName <- iconv(occurrence$scientificName, from = "", to = "UTF-8", sub = "")
```

```{r}
occurrence %<>% mutate (verbatimScientificNAme = scientificName)
```
# .*$ â†’ everything after it until the end of the string


```{r}
# Step 2: clean 'spec.', 'sp.', 'spp.' only in character strings
occurrence <- occurrence %>%
  mutate(
    scientificName = ifelse(
      is.na(scientificName),
      NA_character_,
      trimws(gsub("\\s+(spec|sp|spp)\\.*$", "", scientificName, ignore.case = TRUE))
    ),
    occurrenceStatus = case_when(
      is.na(organismQuantity) ~ NA_character_,
      organismQuantity > 0 ~ "present",
      TRUE ~ "absent"
    )
  )
```


## remove obsolete columns



# Term mapping

Map the data to [Darwin Core Occurrence](http://rs.gbif.org/core/dwc_occurrence_2015-07-02.xml).

Start with record-level terms which contain metadata about the dataset (which is generally the same for all records).

# Event

### datasetID

```{r}
event %<>% mutate(datasetID = "https://doi.org/10.15468/tjbpz7")
```

### add row numbers to genrate occurrenceID unique




### type

```{r}
event %<>% mutate(type = "Event")
```

### language

```{r}
event %<>% mutate(language = "en") # e.g. "en"
```

### license

```{r}
event %<>% mutate(license = "https://creativecommons.org/licenses/by/4.0/") 
# e.g. "http://creativecommons.org/publicdomain/zero/1.0/"
```

### rightsHolder

```{r}
event %<>% mutate(rightsHolder = "KUL") # e.g. "INBO"
```
### accessRights

```{r}
event %<>% mutate(accessRights = "http://www.inbo.be/en/norms-for-data-use") 
```

### datasetID

```{r}
#occurrence %<>% mutate(datasetID = "insert doi") 
```

### institutionCode

```{r}
event %<>% mutate(institutionCode = "KUL") # e.g. "INBO"
```

### datasetName

```{r}
event %<>% mutate(datasetName = "De Maten, Belgium") # e.g. "Checklist of non-native freshwater fishes in Flanders, Belgium"
```

The following terms contain information about the taxon:


### informationWithHeld

### dataGeneralizations

### occurrenceID

### recordedBy


### individualCount

### organismQuantity



### organismQuentityType


### sex

### lifeStage

### behavior

### occurrenceRemarks


## samplingProtocol


### samplingEffort


### eventDate

eventDate already ok in source file (should be)

```{r}
event %<>% mutate(year = eventDate)
```

# Location

```{r}
event %<>%
  rename(decimalLongitude = X) %>%
  rename(decimalLatitude = Y) %>%
  mutate(geodeticDatum = "WGS84") %>%
  mutate(coordinateUncertaintyInMeters = "30") %>%
  mutate(verbatimCoordinateSystem = "UTM") %>%
  mutate(verbatimSRS = "Belgium Date 1972") %>%
  mutate(countryCode = "BE")  %>%            
  mutate(continent = "Europe")
```

```{r}
head(event, n = 5)
event %<>%
  mutate(verbatimLongitude = round(verbatimLongitude)) %>%
  mutate(verbatimLatitude = round(verbatimLatitude)) %>%
  mutate(decimalLongitude = round(decimalLongitude, digits = 5)) %>%
  mutate(decimalLatitude = round(decimalLatitude, digits = 5))
```

```{r}
event %<>%   
   mutate(decimalLatitude = as.character(format(decimalLatitude, nsmall = 5))) %>%
   mutate(decimalLongitude = as.character(format(decimalLongitude, nsmall = 5)))
```

### continent

```{r}
event %<>% mutate(continent = "Europe") # e.g. "Belgium = BE"
```

### countryCode

```{r}
event %<>% mutate(countryCode = "BE") # e.g. "Belgium = BE"
```

### municipality

### verbatimcoordinates

### verbatimLatitude

### verbatimLongitude

### verbatimcoordinatesystem

### verbatimSRS

### decimalLatitude

### decimalLongitude

### geodeticDatum

### coordinateUncertaintyInMeters

### georeferenceRemarks

### identifiedBy


### scientificName 


### kingdom


### scientificNameAuthorship


### taxonRank


### nomenclaturalCode

```{r}
event %<>% mutate(nomenclaturalCode = "ICZN") # e.g. "ICZN"
```

### occurrenceStatus



## Post-processing


```{r}
event <- mutate_all(event, as.character())
```

Define the order of the output columns


Preview data:

```{r}
event %>% head()
```

Save to CSV:

```{r}
write_csv(event, here::here("datasets", "biofresh-dematen", "data", "processed", "event.csv"), na = "")
```

```{r}
write_csv(occurrence, here::here("datasets", "biofresh-dematen", "data", "processed", "occurrence.csv"), na = "")
```